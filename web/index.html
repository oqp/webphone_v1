<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Agent â€” Panel de Control</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0b0f;
    --surface: #12141a;
    --surface-2: #1a1d26;
    --surface-3: #222633;
    --border: #2a2e3a;
    --text: #e4e6ed;
    --text-dim: #7a7f92;
    --text-muted: #4a4f62;
    --accent: #22d3a7;
    --accent-dim: rgba(34,211,167,0.12);
    --accent-glow: rgba(34,211,167,0.25);
    --red: #ef4444;
    --red-dim: rgba(239,68,68,0.12);
    --yellow: #f59e0b;
    --yellow-dim: rgba(245,158,11,0.12);
    --blue: #3b82f6;
    --blue-dim: rgba(59,130,246,0.12);
    --radius: 12px;
    --font: 'Plus Jakarta Sans', sans-serif;
    --mono: 'JetBrains Mono', monospace;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:var(--font); min-height:100vh; }

  .header {
    padding:20px 32px; display:flex; align-items:center; justify-content:space-between;
    border-bottom:1px solid var(--border); background:var(--surface); position:sticky; top:0; z-index:100;
  }
  .header-left { display:flex; align-items:center; gap:14px; }
  .logo-icon {
    width:38px; height:38px; background:linear-gradient(135deg, var(--accent), #17a685);
    border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px;
    box-shadow:0 4px 20px var(--accent-glow);
  }
  .logo-text { font-size:18px; font-weight:800; }
  .logo-text span { color:var(--accent); }
  .header-status { display:flex; align-items:center; gap:20px; }
  .status-pill {
    display:flex; align-items:center; gap:8px; padding:6px 14px; border-radius:20px;
    font-size:12px; font-weight:600;
  }
  .status-pill.online { background:var(--accent-dim); color:var(--accent); }
  .status-pill.offline { background:var(--red-dim); color:var(--red); }
  .status-pill.calling { background:var(--yellow-dim); color:var(--yellow); }
  .status-dot { width:7px; height:7px; border-radius:50%; background:currentColor; animation:pulse-dot 2s infinite; }
  @keyframes pulse-dot { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

  .main { display:grid; grid-template-columns:380px 1fr; min-height:calc(100vh - 80px); }
  .sidebar { background:var(--surface); border-right:1px solid var(--border); padding:24px; display:flex; flex-direction:column; gap:20px; }
  .section-title { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); margin-bottom:4px; }
  .card { background:var(--surface-2); border:1px solid var(--border); border-radius:var(--radius); padding:20px; }
  .config-grid { display:grid; gap:12px; }
  .config-field label { display:block; font-size:11px; font-weight:600; color:var(--text-dim); margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px; }
  .config-field input {
    width:100%; padding:10px 12px; background:var(--surface-3); border:1px solid var(--border);
    border-radius:8px; color:var(--text); font-family:var(--mono); font-size:13px; outline:none;
  }
  .config-field input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-dim); }
  .config-field input::placeholder { color:var(--text-muted); }
  .config-row { display:grid; grid-template-columns:1fr 100px; gap:8px; }

  .phone-display {
    background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:16px 20px;
    text-align:center; font-family:var(--mono); font-size:28px; font-weight:600; letter-spacing:3px;
    min-height:62px; display:flex; align-items:center; justify-content:center;
  }
  .phone-display.calling { color:var(--accent); animation:glow-text 1.5s ease-in-out infinite; }
  @keyframes glow-text { 0%,100%{text-shadow:0 0 10px transparent;} 50%{text-shadow:0 0 20px var(--accent-glow);} }

  .dialpad { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px; }
  .dial-btn {
    padding:14px 0; background:var(--surface-3); border:1px solid var(--border); border-radius:10px;
    color:var(--text); font-family:var(--font); font-size:20px; font-weight:600; cursor:pointer; user-select:none;
  }
  .dial-btn:hover { background:var(--border); transform:scale(1.04); }
  .dial-btn:active { transform:scale(0.96); }
  .dial-btn sub { display:block; font-size:9px; color:var(--text-muted); font-weight:500; letter-spacing:2px; }

  .call-actions { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
  .btn {
    padding:14px 20px; border:none; border-radius:10px; font-family:var(--font); font-size:14px;
    font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn-call { background:var(--accent); color:#0a0b0f; grid-column:span 2; }
  .btn-call:hover { box-shadow:0 6px 25px var(--accent-glow); }
  .btn-call:disabled { opacity:0.4; cursor:not-allowed; }
  .btn-hangup { background:var(--red); color:#fff; grid-column:span 2; display:none; }
  .btn-hangup.visible { display:flex; }
  .btn-register { background:var(--blue); color:#fff; grid-column:span 2; }
  .btn-secondary { background:var(--surface-3); color:var(--text); border:1px solid var(--border); }

  .content { display:flex; flex-direction:column; overflow:hidden; }
  .stats-bar { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; padding:20px 28px; border-bottom:1px solid var(--border); }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px 18px; }
  .stat-label { font-size:11px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.8px; }
  .stat-value { font-size:28px; font-weight:800; margin-top:4px; font-family:var(--mono); }
  .stat-value.green { color:var(--accent); }
  .stat-value.blue { color:var(--blue); }
  .stat-value.yellow { color:var(--yellow); }

  .panels { display:grid; grid-template-columns:1fr 1fr; flex:1; overflow:hidden; }
  .panel { display:flex; flex-direction:column; overflow:hidden; }
  .panel:first-child { border-right:1px solid var(--border); }
  .panel-header { padding:16px 24px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
  .panel-title { font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; }
  .panel-badge { background:var(--accent-dim); color:var(--accent); padding:3px 10px; border-radius:12px; font-size:11px; font-weight:700; }
  .panel-body { flex:1; overflow-y:auto; padding:16px 24px; display:flex; flex-direction:column; gap:12px; }

  .msg { display:flex; gap:12px; animation:msg-in 0.3s ease-out; }
  @keyframes msg-in { from{opacity:0;transform:translateY(8px);} to{opacity:1;transform:translateY(0);} }
  .msg-avatar { width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:14px; flex-shrink:0; }
  .msg-avatar.user { background:var(--blue-dim); }
  .msg-avatar.agent { background:var(--accent-dim); }
  .msg-content { flex:1; }
  .msg-name { font-size:12px; font-weight:700; margin-bottom:3px; }
  .msg-name.user { color:var(--blue); }
  .msg-name.agent { color:var(--accent); }
  .msg-text { font-size:14px; line-height:1.5; color:var(--text-dim); }
  .msg-time { font-size:10px; color:var(--text-muted); margin-top:4px; font-family:var(--mono); }

  .log-entry { font-family:var(--mono); font-size:12px; line-height:1.6; color:var(--text-dim); padding:4px 0; animation:msg-in 0.2s ease-out; }
  .log-entry .time { color:var(--text-muted); }
  .log-entry .tag { padding:1px 6px; border-radius:3px; font-size:10px; font-weight:600; margin:0 4px; }
  .tag-sip { background:var(--blue-dim); color:var(--blue); }
  .tag-dg { background:var(--accent-dim); color:var(--accent); }
  .tag-err { background:var(--red-dim); color:var(--red); }
  .tag-info { background:var(--yellow-dim); color:var(--yellow); }

  .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; gap:8px; color:var(--text-muted); text-align:center; padding:40px; }
  .empty-state .icon { font-size:40px; margin-bottom:8px; opacity:0.5; }

  .waveform { display:flex; align-items:center; justify-content:center; gap:3px; height:40px; margin:12px 0; }
  .wave-bar { width:4px; background:var(--accent); border-radius:2px; }
  .waveform.active .wave-bar { animation:wave 0.8s ease-in-out infinite; }
  @keyframes wave { 0%,100%{height:6px;opacity:0.3;} 50%{height:30px;opacity:1;} }
  .waveform.active .wave-bar:nth-child(1) { animation-delay:0s; }
  .waveform.active .wave-bar:nth-child(2) { animation-delay:0.1s; }
  .waveform.active .wave-bar:nth-child(3) { animation-delay:0.2s; }
  .waveform.active .wave-bar:nth-child(4) { animation-delay:0.3s; }
  .waveform.active .wave-bar:nth-child(5) { animation-delay:0.2s; }
  .waveform.active .wave-bar:nth-child(6) { animation-delay:0.1s; }
  .waveform.active .wave-bar:nth-child(7) { animation-delay:0s; }
  .call-timer { font-family:var(--mono); font-size:24px; font-weight:600; text-align:center; color:var(--accent); display:none; }
  .call-timer.visible { display:block; }

  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  @media (max-width:1024px) {
    .main { grid-template-columns:1fr; }
    .panels { grid-template-columns:1fr; }
    .stats-bar { grid-template-columns:repeat(2,1fr); }
  }
</style>
</head>
<body>

<header class="header">
  <div class="header-left">
    <div class="logo-icon">ðŸŽ™</div>
    <div class="logo-text">Voice<span>Agent</span></div>
  </div>
  <div class="header-status">
    <div class="status-pill offline" id="statusJanus"><div class="status-dot"></div><span>JANUS: DESCONECTADO</span></div>
    <div class="status-pill offline" id="statusSip"><div class="status-dot"></div><span>SIP: NO REGISTRADO</span></div>
  </div>
</header>

<div class="main">
  <aside class="sidebar">
    <div class="section-title">Conexion SIP</div>
    <div class="card">
      <div class="config-grid">
        <div class="config-field">
          <label>Servidor Janus (WebSocket)</label>
          <input id="cfgJanusUrl" type="text" value="ws://localhost:8188">
        </div>
        <div class="config-row">
          <div class="config-field"><label>IP de la UCM</label><input id="cfgUcmHost" type="text" value="45.32.169.45"></div>
          <div class="config-field"><label>Puerto</label><input id="cfgUcmPort" type="text" value="5060"></div>
        </div>
        <div class="config-row">
          <div class="config-field"><label>Extension</label><input id="cfgExtension" type="text" value="9000"></div>
          <div class="config-field"><label>Password</label><input id="cfgPassword" type="password"></div>
        </div>
        <button class="btn btn-register" id="btnRegister" onclick="doRegister()">âš¡ Conectar y Registrar</button>
      </div>
    </div>
    <div class="section-title">Telefono WebRTC</div>
    <div class="card">
      <div class="phone-display" id="phoneDisplay">_</div>
      <div class="waveform" id="waveform">
        <div class="wave-bar" style="height:6px"></div><div class="wave-bar" style="height:6px"></div>
        <div class="wave-bar" style="height:6px"></div><div class="wave-bar" style="height:6px"></div>
        <div class="wave-bar" style="height:6px"></div><div class="wave-bar" style="height:6px"></div>
        <div class="wave-bar" style="height:6px"></div>
      </div>
      <div class="call-timer" id="callTimer">00:00</div>
      <div class="dialpad">
        <button class="dial-btn" onclick="dialPress('1')">1<sub>&nbsp;</sub></button>
        <button class="dial-btn" onclick="dialPress('2')">2<sub>ABC</sub></button>
        <button class="dial-btn" onclick="dialPress('3')">3<sub>DEF</sub></button>
        <button class="dial-btn" onclick="dialPress('4')">4<sub>GHI</sub></button>
        <button class="dial-btn" onclick="dialPress('5')">5<sub>JKL</sub></button>
        <button class="dial-btn" onclick="dialPress('6')">6<sub>MNO</sub></button>
        <button class="dial-btn" onclick="dialPress('7')">7<sub>PQRS</sub></button>
        <button class="dial-btn" onclick="dialPress('8')">8<sub>TUV</sub></button>
        <button class="dial-btn" onclick="dialPress('9')">9<sub>WXYZ</sub></button>
        <button class="dial-btn" onclick="dialPress('*')">*</button>
        <button class="dial-btn" onclick="dialPress('0')">0<sub>+</sub></button>
        <button class="dial-btn" onclick="dialPress('#')">#</button>
      </div>
      <div class="call-actions">
        <button class="btn btn-call" id="btnCall" onclick="doCall()" disabled>ðŸ“ž Llamar</button>
        <button class="btn btn-hangup" id="btnHangup" onclick="doHangup()">ðŸ“´ Colgar</button>
      </div>
    </div>
  </aside>

  <div class="content">
    <div class="stats-bar">
      <div class="stat-card"><div class="stat-label">Estado</div><div class="stat-value green" id="statStatus">Offline</div></div>
      <div class="stat-card"><div class="stat-label">Llamadas Hoy</div><div class="stat-value blue" id="statCalls">0</div></div>
      <div class="stat-card"><div class="stat-label">Duracion Prom.</div><div class="stat-value yellow" id="statDuration">â€”</div></div>
      <div class="stat-card"><div class="stat-label">Ultima Llamada</div><div class="stat-value" id="statLast" style="font-size:16px;color:var(--text-dim)">â€”</div></div>
    </div>
    <div class="panels">
      <div class="panel">
        <div class="panel-header"><span class="panel-title">ðŸ’¬ Conversacion en Vivo</span><span class="panel-badge" id="transcriptBadge">EN ESPERA</span></div>
        <div class="panel-body" id="transcriptPanel">
          <div class="empty-state"><div class="icon">ðŸŽ§</div><p>La transcripcion aparecera aqui cuando haya una llamada activa</p></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><span class="panel-title">ðŸ“‹ Logs del Sistema</span><button class="btn btn-secondary" onclick="clearLogs()" style="padding:5px 12px;font-size:11px;">Limpiar</button></div>
        <div class="panel-body" id="logsPanel">
          <div class="log-entry"><span class="time">--:--:--</span><span class="tag tag-info">SYS</span> Panel web iniciado. Conecta a Janus para comenzar.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<audio id="remoteAudio" autoplay></audio>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JANUS SIP CLIENT - VERSIÃ“N CORREGIDA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let janus = {
  ws: null,
  sessionId: null,
  handleId: null,
  txPending: {},
  txCounter: 0
};

let callState = {
  active: false,
  registered: false,
  dialBuffer: '',
  startTime: null,
  timerInterval: null,
  count: 0,
  totalDuration: 0
};

let pc = null;

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const $ = id => document.getElementById(id);

function setStatus(id, text, cls) {
  const el = $(id);
  el.className = 'status-pill ' + cls;
  el.querySelector('span').textContent = text;
}

function addLog(tag, cls, msg) {
  const t = new Date().toLocaleTimeString('es-PE');
  const p = $('logsPanel');
  const e = p.querySelector('.empty-state');
  if (e) e.remove();
  const d = document.createElement('div');
  d.className = 'log-entry';
  d.innerHTML = '<span class="time">' + t + '</span> <span class="tag ' + cls + '">' + tag + '</span> ' + msg;
  p.appendChild(d);
  p.scrollTop = p.scrollHeight;
}

function clearLogs() { $('logsPanel').innerHTML = ''; addLog('SYS','tag-info','Logs limpiados'); }

function dialPress(d) {
  callState.dialBuffer += d;
  $('phoneDisplay').textContent = callState.dialBuffer || '_';
  if (callState.active && janus.handleId) {
    janusSendPlugin({ request: 'dtmf_info', digit: d });
  }
}

// â”€â”€ JANUS COMMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function janusTx() { return 'tx' + (++janus.txCounter); }

function janusSend(msg) {
  return new Promise((resolve, reject) => {
    const tx = janusTx();
    msg.transaction = tx;
    janus.txPending[tx] = { resolve, reject };
    try {
      janus.ws.send(JSON.stringify(msg));
    } catch(e) {
      delete janus.txPending[tx];
      reject(e);
    }
  });
}

function janusSendPlugin(body, jsep) {
  const msg = {
    janus: 'message',
    session_id: janus.sessionId,
    handle_id: janus.handleId,
    body: body
  };
  if (jsep) msg.jsep = jsep;
  // Plugin messages get ack first, then event - don't await
  const tx = janusTx();
  msg.transaction = tx;
  janus.ws.send(JSON.stringify(msg));
  addLog('>>','tag-info', 'Enviado: ' + body.request);
}

function janusHandleMessage(data) {
  const tx = data.transaction;
  const janusType = data.janus;

  // Match pending transactions
  if (tx && janus.txPending[tx]) {
    const p = janus.txPending[tx];
    delete janus.txPending[tx];

    if (janusType === 'success') {
      p.resolve(data);
      return;
    } else if (janusType === 'error') {
      const err = data.error || {};
      addLog('ERR','tag-err', 'Janus error ' + err.code + ': ' + err.reason);
      p.reject(new Error(err.reason || 'Janus error'));
      return;
    } else if (janusType === 'ack') {
      // Ack for plugin messages - resolve but event comes separately
      p.resolve(data);
      return;
    }
  }

  // Plugin events
  if (janusType === 'event') {
    const pd = (data.plugindata || {}).data || {};
    const result = pd.result || {};
    const event = result.event || pd.event || pd.sip;
    const jsep = data.jsep;

    addLog('<<','tag-sip', 'Evento: ' + (event || 'unknown') + (result.code ? ' (' + result.code + ')' : ''));

    if (event === 'registered') {
      callState.registered = true;
      setStatus('statusSip', 'SIP: ' + $('cfgExtension').value + ' REGISTRADO', 'online');
      $('btnCall').disabled = false;
      $('statStatus').textContent = 'Listo';
      addLog('SIP','tag-sip', 'âœ… Registrado exitosamente!');
    }
    else if (event === 'registration_failed') {
      setStatus('statusSip', 'SIP: REGISTRO FALLIDO', 'offline');
      addLog('ERR','tag-err', 'Registro fallido: ' + (result.code||'?') + ' - ' + (result.reason||'?'));
    }
    else if (event === 'incomingcall') {
      addLog('SIP','tag-sip', 'ðŸ“ž Llamada entrante de: ' + (result.username || result.displayname || '?'));
      handleIncomingCall(data);
    }
    else if (event === 'accepted') {
      callState.active = true;
      stopRingback();
      setStatus('statusSip', 'SIP: EN LLAMADA', 'calling');
      $('waveform').classList.add('active');
      $('transcriptBadge').textContent = 'EN VIVO';
      $('phoneDisplay').classList.add('calling');
      $('btnCall').style.display = 'none';
      $('btnHangup').classList.add('visible');
      startTimer();
      callState.count++;
      $('statCalls').textContent = callState.count;
      addLog('SIP','tag-sip', 'âœ… Llamada conectada');
      if (jsep && pc) pc.setRemoteDescription(new RTCSessionDescription(jsep));
    }
    else if (event === 'hangup' || event === 'declining') {
      endCall(result.reason || result.code || 'finalizada');
    }
    else if (event === 'calling') {
      $('phoneDisplay').textContent = 'ðŸ“ž Llamando...';
      $('phoneDisplay').classList.add('calling');
      startRingback();
    }
    else if (event === 'ringing' || event === 'progress') {
      $('phoneDisplay').textContent = 'ðŸ”” Timbrando...';
      startRingback();
      if (jsep && pc) pc.setRemoteDescription(new RTCSessionDescription(jsep));
    }
  }
  else if (janusType === 'hangup') {
    endCall(data.reason || 'hangup');
  }
  else if (janusType === 'webrtcup') {
    addLog('RTC','tag-info', 'ðŸ”— WebRTC activa');
  }
  else if (janusType === 'media') {
    addLog('RTC','tag-info', 'Media ' + data.type + ': receiving=' + data.receiving);
  }
}

// â”€â”€ CONNECT & REGISTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function doRegister() {
  const url = $('cfgJanusUrl').value;
  addLog('WS','tag-info', 'Conectando a ' + url + '...');

  try {
    janus.ws = new WebSocket(url, 'janus-protocol');
  } catch(e) {
    addLog('ERR','tag-err', 'No se pudo crear WebSocket: ' + e.message);
    return;
  }

  janus.ws.onopen = async () => {
    addLog('WS','tag-info', 'WebSocket conectado');
    setStatus('statusJanus', 'JANUS: CONECTADO', 'online');

    try {
      // 1. Crear sesiÃ³n
      addLog('SIP','tag-sip', 'Creando sesion...');
      const createResp = await janusSend({ janus: 'create' });
      janus.sessionId = createResp.data.id;
      addLog('SIP','tag-sip', 'Sesion creada: ' + janus.sessionId);

      // 2. Adjuntar plugin SIP
      addLog('SIP','tag-sip', 'Adjuntando plugin SIP...');
      const attachResp = await janusSend({
        janus: 'attach',
        session_id: janus.sessionId,
        plugin: 'janus.plugin.sip'
      });
      janus.handleId = attachResp.data.id;
      addLog('SIP','tag-sip', 'Plugin SIP adjuntado (handle=' + janus.handleId + ')');

      // 3. Iniciar keepalive
      setInterval(() => {
        if (janus.ws && janus.ws.readyState === 1 && janus.sessionId) {
          janus.ws.send(JSON.stringify({
            janus: 'keepalive',
            session_id: janus.sessionId,
            transaction: janusTx()
          }));
        }
      }, 25000);

      // 4. Registrar en la UCM
      const host = $('cfgUcmHost').value;
      const port = $('cfgUcmPort').value;
      const ext = $('cfgExtension').value;
      const pwd = $('cfgPassword').value;

      addLog('SIP','tag-sip', 'Registrando ext ' + ext + ' en ' + host + ':' + port + '...');

      janusSendPlugin({
        request: 'register',
        username: 'sip:' + ext + '@' + host,
        authuser: ext,
        display_name: 'Web Agent Panel',
        secret: pwd,
        proxy: 'sip:' + host + ':' + port,
        force_udp: true
      });

    } catch(e) {
      addLog('ERR','tag-err', 'Error en secuencia de conexion: ' + e.message);
    }
  };

  janus.ws.onmessage = (evt) => {
    try {
      const data = JSON.parse(evt.data);
      janusHandleMessage(data);
    } catch(e) {
      addLog('ERR','tag-err', 'Error procesando mensaje: ' + e.message);
    }
  };

  janus.ws.onclose = () => {
    addLog('WS','tag-err', 'WebSocket desconectado');
    setStatus('statusJanus', 'JANUS: DESCONECTADO', 'offline');
    setStatus('statusSip', 'SIP: NO REGISTRADO', 'offline');
    callState.registered = false;
    $('btnCall').disabled = true;
    $('statStatus').textContent = 'Offline';
  };

  janus.ws.onerror = () => {
    addLog('ERR','tag-err', 'Error en WebSocket');
  };
}

// â”€â”€ WEBRTC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function createPC() {
  pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
  pc.onicecandidate = (e) => { if (!e.candidate) addLog('RTC','tag-info','ICE completo'); };
  pc.ontrack = (e) => { $('remoteAudio').srcObject = e.streams[0]; addLog('RTC','tag-info','Audio remoto recibido'); };
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  stream.getTracks().forEach(t => pc.addTrack(t, stream));
  addLog('RTC','tag-info', 'Microfono activado');
  return pc;
}

async function doCall() {
  if (!callState.registered || !callState.dialBuffer) return;
  if (pc) { addLog('ERR','tag-err','Ya hay una llamada en curso'); return; }
  const uri = 'sip:' + callState.dialBuffer + '@' + $('cfgUcmHost').value;
  addLog('SIP','tag-sip', 'Llamando a ' + uri);
  $('btnCall').disabled = true;
  try {
    await createPC();
    const offer = await pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: false });
    await pc.setLocalDescription(offer);
    addLog('RTC','tag-info', 'SDP offer creado, enviando a Janus...');
    // NO esperar ICE gathering - enviar de inmediato, Janus soporta trickle
    janusSendPlugin({ request: 'call', uri: uri }, { type: 'offer', sdp: offer.sdp });
    addLog('>>','tag-info', 'Enviado: call');
    $('phoneDisplay').textContent = 'ðŸ“ž Llamando...';
    $('phoneDisplay').classList.add('calling');
  } catch(e) {
    addLog('ERR','tag-err', 'Error llamando: ' + e.message);
    if (pc) { pc.close(); pc = null; }
    $('btnCall').disabled = false;
  }
}

async function handleIncomingCall(data) {
  try {
    await createPC();
    if (data.jsep) {
      await pc.setRemoteDescription(new RTCSessionDescription(data.jsep));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      addLog('RTC','tag-info', 'SDP answer creado, aceptando llamada...');
      // NO esperar ICE - enviar de inmediato
      janusSendPlugin({ request: 'accept' }, { type: 'answer', sdp: answer.sdp });
      addLog('>>','tag-info', 'Enviado: accept');
    }
  } catch(e) { addLog('ERR','tag-err', 'Error aceptando: ' + e.message); }
}

function doHangup() {
  if (janus.handleId) janusSendPlugin({ request: 'hangup' });
  endCall('usuario colgo');
}

function startTimer() {
  callState.startTime = Date.now();
  $('callTimer').classList.add('visible');
  callState.timerInterval = setInterval(() => {
    const s = Math.floor((Date.now() - callState.startTime) / 1000);
    $('callTimer').textContent = String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0');
  }, 1000);
}

function endCall(reason) {
  stopRingback();
  addLog('SIP','tag-sip', 'ðŸ“´ Llamada finalizada: ' + reason);
  callState.active = false;
  $('waveform').classList.remove('active');
  $('phoneDisplay').classList.remove('calling');
  $('phoneDisplay').textContent = '_';
  $('btnCall').style.display = '';
  $('btnHangup').classList.remove('visible');
  $('btnCall').disabled = !callState.registered;
  $('transcriptBadge').textContent = 'FINALIZADA';
  callState.dialBuffer = '';
  if (callState.timerInterval) clearInterval(callState.timerInterval);
  $('callTimer').classList.remove('visible');
  if (callState.startTime) { callState.totalDuration += Math.floor((Date.now()-callState.startTime)/1000); callState.startTime=null; }
  if (callState.registered) { setStatus('statusSip','SIP: '+$('cfgExtension').value+' REGISTRADO','online'); $('statStatus').textContent='Listo'; }
  if (callState.count>0) $('statDuration').textContent = Math.round(callState.totalDuration/callState.count)+'s';
  $('statLast').textContent = new Date().toLocaleTimeString('es-PE');
  if (pc) { pc.close(); pc = null; }
}

// â”€â”€ RINGBACK TONE (Tono de timbrado local) â”€â”€â”€â”€â”€â”€
// PatrÃ³n PerÃº/NorteamÃ©rica: 440Hz + 480Hz, 2s ON, 4s OFF
let ringbackCtx = null;
let ringbackOsc1 = null;
let ringbackOsc2 = null;
let ringbackGain = null;
let ringbackInterval = null;
let ringbackOn = false;

function startRingback() {
  if (ringbackOn) return;
  ringbackOn = true;
  try {
    ringbackCtx = new (window.AudioContext || window.webkitAudioContext)();
    ringbackGain = ringbackCtx.createGain();
    ringbackGain.gain.value = 0;
    ringbackGain.connect(ringbackCtx.destination);

    ringbackOsc1 = ringbackCtx.createOscillator();
    ringbackOsc1.frequency.value = 440;
    ringbackOsc1.type = 'sine';

    ringbackOsc2 = ringbackCtx.createOscillator();
    ringbackOsc2.frequency.value = 480;
    ringbackOsc2.type = 'sine';

    // Mezclar ambos tonos con volumen bajo
    const mix1 = ringbackCtx.createGain();
    mix1.gain.value = 0.15;
    const mix2 = ringbackCtx.createGain();
    mix2.gain.value = 0.15;

    ringbackOsc1.connect(mix1);
    ringbackOsc2.connect(mix2);
    mix1.connect(ringbackGain);
    mix2.connect(ringbackGain);

    ringbackOsc1.start();
    ringbackOsc2.start();

    // PatrÃ³n: 2s ON, 4s OFF
    ringbackGain.gain.value = 1;
    ringbackInterval = setInterval(() => {
      if (!ringbackOn) return;
      ringbackGain.gain.value = 1;
      setTimeout(() => {
        if (ringbackGain) ringbackGain.gain.value = 0;
      }, 2000);
    }, 6000);

    addLog('SND','tag-info', 'ðŸ”Š Ringback tone activado');
  } catch(e) {
    addLog('ERR','tag-err', 'Error creando ringback: ' + e.message);
  }
}

function stopRingback() {
  if (!ringbackOn) return;
  ringbackOn = false;
  if (ringbackInterval) { clearInterval(ringbackInterval); ringbackInterval = null; }
  if (ringbackOsc1) { try { ringbackOsc1.stop(); } catch(e){} ringbackOsc1 = null; }
  if (ringbackOsc2) { try { ringbackOsc2.stop(); } catch(e){} ringbackOsc2 = null; }
  if (ringbackCtx) { try { ringbackCtx.close(); } catch(e){} ringbackCtx = null; }
  ringbackGain = null;
}

</script>
</body>
</html>
